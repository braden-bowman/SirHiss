"""
Trading system database models
Enhanced models for comprehensive trading functionality
"""

from sqlalchemy import Column, Integer, String, Float, DateTime, Text, Boolean, ForeignKey, JSON, Enum
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from datetime import datetime
import enum

from app.core.database import Base

class OrderSide(enum.Enum):
    BUY = "buy"
    SELL = "sell"

class OrderType(enum.Enum):
    MARKET = "market"
    LIMIT = "limit"
    STOP = "stop"
    STOP_LIMIT = "stop_limit"

class OrderStatus(enum.Enum):
    PENDING = "pending"
    FILLED = "filled"
    CANCELLED = "cancelled"
    REJECTED = "rejected"

# Import existing TradingBot from trading_bot.py to avoid duplication
from .trading_bot import TradingBot

class BotExecution(Base):
    """Trading execution records"""
    __tablename__ = "bot_executions"

    id = Column(Integer, primary_key=True, index=True)
    bot_id = Column(Integer, ForeignKey("trading_bots.id"), nullable=False)
    
    # Trade details
    strategy_name = Column(String(100), nullable=False)
    symbol = Column(String(20), nullable=False)
    side = Column(Enum(OrderSide), nullable=False)
    quantity = Column(Float, nullable=False)
    price = Column(Float, nullable=False)
    total_value = Column(Float, nullable=False)
    
    # Order information
    order_id = Column(String(100))
    order_type = Column(Enum(OrderType), default=OrderType.MARKET)
    order_status = Column(Enum(OrderStatus), default=OrderStatus.PENDING)
    
    # Signal information
    signal_strength = Column(Float, default=0.0)
    signal_metadata = Column(JSON, default={})
    
    # Execution details
    execution_price = Column(Float)
    fees = Column(Float, default=0.0)
    slippage = Column(Float, default=0.0)
    
    # Timestamps
    timestamp = Column(DateTime, default=datetime.utcnow)
    execution_time = Column(DateTime)
    
    # Additional metadata
    execution_metadata = Column(JSON, default={})
    
    # Relationships
    bot = relationship("TradingBot", back_populates="executions")

class Holdings(Base):
    """Current holdings for each bot"""
    __tablename__ = "holdings"

    id = Column(Integer, primary_key=True, index=True)
    bot_id = Column(Integer, ForeignKey("trading_bots.id"), nullable=False)
    portfolio_id = Column(Integer, ForeignKey("portfolios.id"), nullable=False)
    
    # Position details
    symbol = Column(String(20), nullable=False)
    quantity = Column(Float, nullable=False)
    average_cost = Column(Float, nullable=False)
    current_price = Column(Float, default=0.0)
    market_value = Column(Float, default=0.0)
    
    # P&L tracking
    unrealized_pnl = Column(Float, default=0.0)
    realized_pnl = Column(Float, default=0.0)
    unrealized_pnl_percent = Column(Float, default=0.0)
    
    # Position management
    entry_price = Column(Float, nullable=False)
    entry_time = Column(DateTime, default=datetime.utcnow)
    stop_loss_price = Column(Float)
    take_profit_price = Column(Float)
    
    # Asset information
    asset_type = Column(String(20), default="stock")  # stock, crypto, forex
    exchange = Column(String(50), default="robinhood")
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    bot = relationship("TradingBot", back_populates="holdings")
    portfolio = relationship("Portfolio", back_populates="holdings")

class MarketData(Base):
    """Historical market data storage"""
    __tablename__ = "market_data"

    id = Column(Integer, primary_key=True, index=True)
    
    # Symbol and timeframe
    symbol = Column(String(20), nullable=False, index=True)
    timeframe = Column(String(10), nullable=False)  # 1m, 5m, 1h, 1d
    
    # OHLCV data
    timestamp = Column(DateTime, nullable=False, index=True)
    open_price = Column(Float, nullable=False)
    high_price = Column(Float, nullable=False)
    low_price = Column(Float, nullable=False)
    close_price = Column(Float, nullable=False)
    volume = Column(Float, nullable=False)
    
    # Technical indicators (cached)
    technical_indicators = Column(JSON, default={})
    
    # Market metadata
    exchange = Column(String(50), default="robinhood")
    source = Column(String(50), default="api")
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)

class TradingSignal(Base):
    """Trading signals generated by strategies"""
    __tablename__ = "trading_signals"

    id = Column(Integer, primary_key=True, index=True)
    bot_id = Column(Integer, ForeignKey("trading_bots.id"), nullable=False)
    
    # Signal details
    strategy_name = Column(String(100), nullable=False)
    symbol = Column(String(20), nullable=False)
    signal_type = Column(String(10), nullable=False)  # buy, sell, hold
    strength = Column(Float, nullable=False)  # 0.0 to 1.0
    
    # Market context
    price = Column(Float, nullable=False)
    volume = Column(Float, default=0.0)
    market_cap = Column(Float)
    
    # Technical analysis
    technical_indicators = Column(JSON, default={})
    support_levels = Column(JSON, default=[])
    resistance_levels = Column(JSON, default=[])
    
    # Sentiment analysis
    sentiment_score = Column(Float, default=0.5)  # 0.0 to 1.0
    news_sentiment = Column(Float, default=0.5)
    social_sentiment = Column(Float, default=0.5)
    
    # Risk assessment
    risk_score = Column(Float, default=0.5)  # 0.0 to 1.0
    volatility = Column(Float, default=0.0)
    beta = Column(Float, default=1.0)
    
    # Signal metadata
    confidence_level = Column(Float, default=0.0)
    expected_return = Column(Float, default=0.0)
    expected_risk = Column(Float, default=0.0)
    time_horizon = Column(String(20), default="short")  # short, medium, long
    
    # Execution status
    is_executed = Column(Boolean, default=False)
    execution_id = Column(Integer, ForeignKey("bot_executions.id"))
    
    # Timestamps
    timestamp = Column(DateTime, default=datetime.utcnow)
    expiry_time = Column(DateTime)
    
    # Additional metadata
    execution_metadata = Column(JSON, default={})
    
    # Relationships
    bot = relationship("TradingBot")
    execution = relationship("BotExecution")

class StrategyPerformance(Base):
    """Strategy performance tracking"""
    __tablename__ = "strategy_performance"

    id = Column(Integer, primary_key=True, index=True)
    bot_id = Column(Integer, ForeignKey("trading_bots.id"), nullable=False)
    strategy_name = Column(String(100), nullable=False)
    
    # Performance metrics
    total_trades = Column(Integer, default=0)
    winning_trades = Column(Integer, default=0)
    losing_trades = Column(Integer, default=0)
    win_rate = Column(Float, default=0.0)
    
    # Returns
    total_return = Column(Float, default=0.0)
    avg_return_per_trade = Column(Float, default=0.0)
    best_trade = Column(Float, default=0.0)
    worst_trade = Column(Float, default=0.0)
    
    # Risk metrics
    max_drawdown = Column(Float, default=0.0)
    sharpe_ratio = Column(Float, default=0.0)
    sortino_ratio = Column(Float, default=0.0)
    calmar_ratio = Column(Float, default=0.0)
    volatility = Column(Float, default=0.0)
    
    # Time-based metrics
    avg_holding_period = Column(Float, default=0.0)  # in hours
    trades_per_day = Column(Float, default=0.0)
    
    # Time period
    period_start = Column(DateTime, nullable=False)
    period_end = Column(DateTime, nullable=False)
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    bot = relationship("TradingBot")

class RiskMetrics(Base):
    """Portfolio and bot risk metrics"""
    __tablename__ = "risk_metrics"

    id = Column(Integer, primary_key=True, index=True)
    bot_id = Column(Integer, ForeignKey("trading_bots.id"))
    user_id = Column(Integer, ForeignKey("users.id"))
    
    # Portfolio metrics
    portfolio_value = Column(Float, nullable=False)
    total_exposure = Column(Float, default=0.0)
    leverage_ratio = Column(Float, default=1.0)
    
    # Risk measures
    value_at_risk_95 = Column(Float, default=0.0)  # 95% VaR
    value_at_risk_99 = Column(Float, default=0.0)  # 99% VaR
    expected_shortfall = Column(Float, default=0.0)  # CVaR
    maximum_drawdown = Column(Float, default=0.0)
    
    # Correlation metrics
    market_correlation = Column(Float, default=0.0)  # Correlation with market
    sector_concentration = Column(JSON, default={})  # Sector exposure
    geographic_concentration = Column(JSON, default={})  # Geographic exposure
    
    # Liquidity metrics
    liquidity_score = Column(Float, default=1.0)  # 0.0 to 1.0
    avg_daily_volume = Column(Float, default=0.0)
    
    # Timestamps
    calculation_date = Column(DateTime, default=datetime.utcnow)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    bot = relationship("TradingBot")
    user = relationship("User")

class Alert(Base):
    """Trading alerts and notifications"""
    __tablename__ = "alerts"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    bot_id = Column(Integer, ForeignKey("trading_bots.id"))
    
    # Alert details
    alert_type = Column(String(50), nullable=False)  # price, signal, risk, system
    severity = Column(String(20), default="medium")  # low, medium, high, critical
    title = Column(String(200), nullable=False)
    message = Column(Text, nullable=False)
    
    # Context
    symbol = Column(String(20))
    current_value = Column(Float)
    threshold_value = Column(Float)
    
    # Status
    is_read = Column(Boolean, default=False)
    is_dismissed = Column(Boolean, default=False)
    is_actionable = Column(Boolean, default=False)
    action_taken = Column(String(100))
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    read_at = Column(DateTime)
    dismissed_at = Column(DateTime)
    
    # Additional data
    execution_metadata = Column(JSON, default={})
    
    # Relationships
    user = relationship("User")
    bot = relationship("TradingBot")

class BacktestResult(Base):
    """Backtesting results storage"""
    __tablename__ = "backtest_results"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    
    # Backtest configuration
    name = Column(String(100), nullable=False)
    description = Column(Text)
    strategy_config = Column(JSON, nullable=False)
    symbols = Column(JSON, nullable=False)  # List of symbols tested
    
    # Time period
    start_date = Column(DateTime, nullable=False)
    end_date = Column(DateTime, nullable=False)
    initial_capital = Column(Float, nullable=False)
    
    # Results
    final_value = Column(Float, nullable=False)
    total_return = Column(Float, nullable=False)
    annualized_return = Column(Float, nullable=False)
    max_drawdown = Column(Float, nullable=False)
    sharpe_ratio = Column(Float, nullable=False)
    sortino_ratio = Column(Float, default=0.0)
    calmar_ratio = Column(Float, default=0.0)
    
    # Trade statistics
    total_trades = Column(Integer, default=0)
    win_rate = Column(Float, default=0.0)
    avg_trade_return = Column(Float, default=0.0)
    best_trade = Column(Float, default=0.0)
    worst_trade = Column(Float, default=0.0)
    
    # Detailed results (stored as JSON)
    equity_curve = Column(JSON, default=[])
    trade_log = Column(JSON, default=[])
    monthly_returns = Column(JSON, default={})
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # Relationships
    user = relationship("User")