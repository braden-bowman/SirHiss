<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üêç SirHiss Trading Dashboard</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
        }
        
        .sidebar-title {
            color: #00ff88;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .user-info {
            padding: 1rem;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            margin: 1rem;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .account-header {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #333;
        }
        
        .account-number {
            color: #00ff88;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .display-name {
            color: #fff;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .username-email {
            color: #aaa;
            font-size: 0.8rem;
        }
        
        .account-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.5rem 0;
            font-size: 0.8rem;
        }
        
        .status-item {
            display: flex;
            align-items: center;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-green { background: #00ff88; }
        .status-yellow { background: #ffd700; }
        .status-red { background: #ff6b6b; }
        .status-gray { background: #666; }
        
        .api-connections {
            margin-top: 1rem;
        }
        
        .api-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .api-title {
            color: #ccc;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .refresh-btn {
            background: none;
            border: 1px solid #333;
            color: #aaa;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover {
            border-color: #00ff88;
            color: #00ff88;
        }
        
        .api-list {
            max-height: 100px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        .api-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .api-list::-webkit-scrollbar-track {
            background: #333;
        }
        
        .api-list::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 2px;
        }
        
        .api-list::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        
        .api-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .api-info {
            flex: 1;
        }
        
        .api-name {
            color: #fff;
            font-weight: bold;
        }
        
        .api-platform {
            color: #aaa;
            font-size: 0.7rem;
        }
        
        .account-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
            font-size: 0.75rem;
        }
        
        .metric-item {
            text-align: center;
        }
        
        .metric-value {
            color: #00ff88;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .metric-label {
            color: #aaa;
            font-size: 0.7rem;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #333;
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* API Connections Management Styles */
        .api-connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .connection-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s;
        }
        
        .connection-card:hover {
            border-color: #00ff88;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.1);
        }
        
        .connection-card.placeholder {
            opacity: 0.6;
            text-align: center;
        }
        
        .connection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .connection-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
        }
        
        .connection-platform {
            color: #00ff88;
            font-size: 0.9rem;
            text-transform: capitalize;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
        }
        
        .connection-details {
            color: #aaa;
            font-size: 0.8rem;
            margin: 0.5rem 0;
        }
        
        .connection-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .btn-test {
            background: #4488ff;
            color: white;
        }
        
        .btn-edit {
            background: #ffa500;
            color: white;
        }
        
        .btn-delete {
            background: #ff6b6b;
            color: white;
        }
        
        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
        }
        
        .setting-label {
            color: #ccc;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .setting-input {
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 0.75rem;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: 0.4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #00ff88;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid #333;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #333;
        }
        
        .modal-title {
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            color: #ccc;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 0.75rem;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }
        
        .form-select {
            width: 100%;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 0.75rem;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .form-help {
            color: #aaa;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #333;
        }
        
        .btn-cancel {
            background: #666;
            color: #fff;
        }
        
        .connection-testing {
            background: rgba(68, 136, 255, 0.1);
            border: 1px solid rgba(68, 136, 255, 0.3);
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            display: none;
        }
        
        .testing-status {
            display: flex;
            align-items: center;
            color: #4488ff;
        }
        
        .testing-status .loading-spinner {
            margin-right: 0.5rem;
        }
        
        /* Security Section Styles */
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-device {
            color: #fff;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .session-details {
            color: #aaa;
            font-size: 0.8rem;
        }
        
        .security-events {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .event-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #333;
        }
        
        .event-item:last-child {
            border-bottom: none;
        }
        
        .event-icon {
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }
        
        .event-info {
            flex: 1;
        }
        
        .event-title {
            color: #fff;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .event-time {
            color: #aaa;
            font-size: 0.8rem;
        }
        
        .nav-menu {
            flex: 1;
            padding: 1rem;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nav-item.active {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
            color: #00ff88;
            font-weight: bold;
        }
        
        .nav-icon {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }
        
        .logout-section {
            padding: 1rem;
            border-top: 1px solid #333;
        }
        
        .logout-btn {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: none;
            border: none;
            color: #ff6b6b;
            width: 100%;
            text-align: left;
        }
        
        .logout-btn:hover {
            background: rgba(255, 107, 107, 0.1);
        }
        
        /* Main Content Styles */
        .main-content {
            margin-left: 240px;
            flex: 1;
            padding: 2rem;
        }
        
        .header {
            margin-bottom: 2rem;
        }
        
        .page-title {
            font-size: 2rem;
            color: #fff;
            margin-bottom: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #333;
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .stat-icon {
            margin-right: 0.5rem;
            font-size: 1.5rem;
        }
        
        .stat-title {
            color: #ccc;
            font-size: 1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stat-change {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .positive {
            color: #00ff88;
        }
        
        .negative {
            color: #ff6b6b;
        }
        
        .content-section {
            background: #1a1a1a;
            border-radius: 12px;
            border: 1px solid #333;
            margin-bottom: 2rem;
        }
        
        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid #333;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #fff;
        }
        
        .section-content {
            padding: 1.5rem;
        }
        
        .bot-list {
            list-style: none;
        }
        
        .bot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #333;
        }
        
        .bot-item:last-child {
            border-bottom: none;
        }
        
        .bot-info h4 {
            color: #fff;
            margin-bottom: 0.25rem;
        }
        
        .bot-info p {
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .bot-status {
            display: flex;
            align-items: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-running { background: #00ff88; }
        .status-stopped { background: #666; }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 0.5rem;
        }
        
        .btn-primary {
            background: #00ff88;
            color: #000;
        }
        
        .btn-secondary {
            background: #333;
            color: #fff;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        
        .alert {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .alert.info {
            background: rgba(68, 136, 255, 0.2);
            border: 1px solid rgba(68, 136, 255, 0.4);
            color: #4488ff;
        }
        
        .welcome-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .welcome-message h3 {
            color: #00ff88;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">üêç SirHiss</div>
        </div>
        
        <div class="user-info">
            <div class="account-header">
                <div class="account-number" id="account-number">Loading...</div>
                <div class="display-name" id="display-name">Loading...</div>
                <div class="username-email">
                    <span id="username-display">loading</span> ‚Ä¢ <span id="email-display">loading</span>
                </div>
            </div>
            
            <div class="account-status">
                <div class="status-item">
                    <span class="status-indicator" id="account-status-indicator"></span>
                    <span id="account-status-text">Loading</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator" id="verification-status-indicator"></span>
                    <span id="verification-status-text">Verifying</span>
                </div>
            </div>
            
            <div class="api-connections">
                <div class="api-header">
                    <span class="api-title">API Connections</span>
                    <button class="refresh-btn" onclick="refreshApiStatus()" id="refresh-api-btn">
                        <span id="refresh-text">Refresh</span>
                    </button>
                </div>
                <div class="api-list" id="api-connections-list">
                    <div class="api-item">
                        <div class="api-info">
                            <div class="api-name">Loading connections...</div>
                        </div>
                        <span class="loading-spinner"></span>
                    </div>
                </div>
            </div>
            
            <div class="account-metrics">
                <div class="metric-item">
                    <div class="metric-value" id="account-age">-</div>
                    <div class="metric-label">Days Active</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="login-count">-</div>
                    <div class="metric-label">Total Logins</div>
                </div>
            </div>
        </div>

        <div class="nav-menu">
            <div class="nav-item active" onclick="showSection('dashboard')">
                <span class="nav-icon">üìä</span>
                Dashboard
            </div>
            <div class="nav-item" onclick="showSection('portfolio')">
                <span class="nav-icon">üíº</span>
                Portfolio
            </div>
            <div class="nav-item" onclick="showSection('market')">
                <span class="nav-icon">üìà</span>
                Market Data
            </div>
            <div class="nav-item" onclick="showSection('bots')">
                <span class="nav-icon">ü§ñ</span>
                Trading Bots
            </div>
            <div class="nav-item" onclick="showSection('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                Settings
            </div>
            <div class="nav-item" onclick="showSection('security')">
                <span class="nav-icon">üîí</span>
                Security
            </div>
        </div>

        <div class="logout-section">
            <button class="logout-btn" onclick="logout()">
                <span class="nav-icon">üö™</span>
                Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="page-section">
            <div class="header">
                <h1 class="page-title">üìä Trading Dashboard</h1>
            </div>

            <div class="welcome-message">
                <h3>Welcome to SirHiss Trading Platform!</h3>
                <p>Your production-ready algorithmic trading platform. Navigate through different sections using the sidebar to manage your trading bots, portfolio, and settings.</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üí∞</span>
                        <span class="stat-title">Portfolio Value</span>
                    </div>
                    <div class="stat-value positive" id="portfolio-value">$15,750.25</div>
                    <div class="stat-change positive">
                        <span>üìà +2.35%</span>
                        <span style="margin-left: 0.5rem;">+$371.25 today</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üíµ</span>
                        <span class="stat-title">Available Cash</span>
                    </div>
                    <div class="stat-value">$2,250.75</div>
                    <div class="stat-change" style="color: #aaa;">
                        <span>Ready to deploy</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">ü§ñ</span>
                        <span class="stat-title">Active Bots</span>
                    </div>
                    <div class="stat-value">2 / 3</div>
                    <div class="stat-change positive">
                        <span>2 running, 1 stopped</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">üìä</span>
                        <span class="stat-title">Holdings</span>
                    </div>
                    <div class="stat-value">5</div>
                    <div class="stat-change" style="color: #aaa;">
                        <span>Positions active</span>
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Active Trading Bots</h2>
                </div>
                <div class="section-content">
                    <ul class="bot-list" id="bot-list">
                        <li class="bot-item">
                            <div class="bot-info">
                                <h4>Tech Growth Bot</h4>
                                <p>Focuses on technology growth stocks ‚Ä¢ 40% allocation ‚Ä¢ $6,450.20 value</p>
                            </div>
                            <div class="bot-status">
                                <span class="status-indicator status-running"></span>
                                <span>Running</span>
                                <button class="btn btn-secondary">Configure</button>
                            </div>
                        </li>
                        <li class="bot-item">
                            <div class="bot-info">
                                <h4>Dividend Hunter</h4>
                                <p>High dividend yield stocks ‚Ä¢ 30% allocation ‚Ä¢ $4,680.50 value</p>
                            </div>
                            <div class="bot-status">
                                <span class="status-indicator status-running"></span>
                                <span>Running</span>
                                <button class="btn btn-secondary">Configure</button>
                            </div>
                        </li>
                        <li class="bot-item">
                            <div class="bot-info">
                                <h4>Crypto Swing</h4>
                                <p>Cryptocurrency swing trading ‚Ä¢ 20% allocation ‚Ä¢ $2,369.55 value</p>
                            </div>
                            <div class="bot-status">
                                <span class="status-indicator status-stopped"></span>
                                <span>Stopped</span>
                                <button class="btn btn-primary">Start Bot</button>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Other sections (hidden by default) -->
        <div id="portfolio-section" class="page-section" style="display: none;">
            <div class="header">
                <h1 class="page-title">üíº Portfolio Overview</h1>
            </div>
            <div class="content-section">
                <div class="section-content">
                    <p>Portfolio management features will be available here. This includes holdings tracking, performance analytics, and portfolio rebalancing tools.</p>
                </div>
            </div>
        </div>

        <div id="market-section" class="page-section" style="display: none;">
            <div class="header">
                <h1 class="page-title">üìà Market Data & Analysis</h1>
            </div>
            <div class="content-section">
                <div class="section-content">
                    <p>Real-time market data, stock search, watchlists, and market analysis tools will be available here. Yahoo Finance integration provides live pricing data.</p>
                </div>
            </div>
        </div>

        <div id="bots-section" class="page-section" style="display: none;">
            <div class="header">
                <h1 class="page-title">ü§ñ Trading Bot Management</h1>
            </div>
            <div class="content-section">
                <div class="section-content">
                    <p>Create, configure, and manage your trading bots here. Set custom strategies, risk parameters, and allocation percentages.</p>
                </div>
            </div>
        </div>

        <div id="settings-section" class="page-section" style="display: none;">
            <div class="header">
                <h1 class="page-title">‚öôÔ∏è API Connections & Settings</h1>
            </div>
            
            <!-- API Connections Section -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Trading Platform Connections</h2>
                    <button class="btn btn-primary" onclick="showAddConnectionModal()">+ Add Connection</button>
                </div>
                <div class="section-content">
                    <div class="api-connections-grid" id="api-connections-grid">
                        <!-- API connections will be loaded here -->
                        <div class="connection-card placeholder">
                            <div class="connection-header">
                                <span class="loading-spinner"></span>
                                <span>Loading connections...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Settings Section -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Trading Preferences</h2>
                </div>
                <div class="section-content">
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">Risk Tolerance</label>
                            <select class="setting-input" id="risk-tolerance">
                                <option value="low">Conservative</option>
                                <option value="medium" selected>Moderate</option>
                                <option value="high">Aggressive</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">Max Position Size</label>
                            <input type="number" class="setting-input" id="max-position-size" 
                                   min="0.01" max="1.0" step="0.01" value="0.05" 
                                   placeholder="0.05 (5%)">
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">Auto-Rebalance</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-rebalance">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">Notifications</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveUserSettings()">Save Settings</button>
                </div>
            </div>
        </div>

        <div id="security-section" class="page-section" style="display: none;">
            <div class="header">
                <h1 class="page-title">üîí Security Settings</h1>
            </div>
            
            <!-- Account Security Section -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Account Security</h2>
                </div>
                <div class="section-content">
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label class="setting-label">Current Password</label>
                            <input type="password" class="setting-input" id="current-password" 
                                   placeholder="Enter current password">
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">New Password</label>
                            <input type="password" class="setting-input" id="new-password" 
                                   placeholder="Enter new password">
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">Confirm New Password</label>
                            <input type="password" class="setting-input" id="confirm-password" 
                                   placeholder="Confirm new password">
                        </div>
                        <div class="setting-item">
                            <label class="setting-label">Two-Factor Authentication</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="two-factor-auth">
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="form-help">Enable 2FA for enhanced security (Coming Soon)</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="updatePassword()">Update Password</button>
                </div>
            </div>
            
            <!-- Session Management -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Active Sessions</h2>
                </div>
                <div class="section-content">
                    <div id="active-sessions-list">
                        <div class="session-item">
                            <div class="session-info">
                                <div class="session-device">üñ•Ô∏è Current Session</div>
                                <div class="session-details">Last active: Just now ‚Ä¢ Current device</div>
                            </div>
                            <span class="status-indicator status-green"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Security Log -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Recent Security Events</h2>
                </div>
                <div class="section-content">
                    <div class="security-events" id="security-events-list">
                        <div class="event-item">
                            <div class="event-icon">üîê</div>
                            <div class="event-info">
                                <div class="event-title">Successful Login</div>
                                <div class="event-time">Just now</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alert container moved to bottom -->
        <div id="alert-container" style="position: fixed; bottom: 20px; left: 260px; right: 20px; z-index: 1000;"></div>
    </div>

    <!-- Add API Connection Modal -->
    <div id="add-connection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add API Connection</h3>
                <button class="close-btn" onclick="closeAddConnectionModal()">&times;</button>
            </div>
            
            <form id="add-connection-form">
                <div class="form-group">
                    <label class="form-label">Platform</label>
                    <select class="form-select" id="platform" onchange="updateConnectionForm()">
                        <option value="">Select a platform...</option>
                        <option value="robinhood">Robinhood</option>
                        <option value="yahoo_finance">Yahoo Finance</option>
                        <option value="alpha_vantage">Alpha Vantage</option>
                    </select>
                    <div class="form-help">Choose the trading platform you want to connect</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Connection Name</label>
                    <input type="text" class="form-input" id="connection-name" 
                           placeholder="e.g., My Robinhood Account" required>
                    <div class="form-help">A friendly name to identify this connection</div>
                </div>
                
                <!-- Robinhood Fields -->
                <div id="robinhood-fields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" id="rh-username" 
                               placeholder="Your Robinhood username">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="rh-password" 
                               placeholder="Your Robinhood password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">MFA Code (if required)</label>
                        <input type="text" class="form-input" id="rh-mfa" 
                               placeholder="6-digit code from authenticator app">
                        <div class="form-help">Only needed if 2FA is enabled on your account</div>
                    </div>
                </div>
                
                <!-- Alpha Vantage Fields -->
                <div id="alpha-vantage-fields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="text" class="form-input" id="av-api-key" 
                               placeholder="Your Alpha Vantage API key">
                        <div class="form-help">
                            Get your free API key from 
                            <a href="https://www.alphavantage.co/support/#api-key" target="_blank" style="color: #00ff88;">alphavantage.co</a>
                        </div>
                    </div>
                </div>
                
                <!-- Yahoo Finance Fields -->
                <div id="yahoo-finance-fields" style="display: none;">
                    <div class="form-help">
                        Yahoo Finance doesn't require authentication. This connection will provide free market data with some rate limits.
                    </div>
                </div>
                
                <!-- Connection Testing -->
                <div id="connection-testing" class="connection-testing">
                    <div class="testing-status">
                        <span class="loading-spinner"></span>
                        <span id="testing-message">Testing connection...</span>
                    </div>
                </div>
            </form>
            
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeAddConnectionModal()">Cancel</button>
                <button class="btn btn-test btn-small" id="test-connection-btn" 
                        onclick="testConnection()" disabled>Test Connection</button>
                <button class="btn btn-primary" id="save-connection-btn" 
                        onclick="saveConnection()" disabled>Save Connection</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:9002';
        
        // Check authentication and load account info
        function checkAuth() {
            // Try both old and new token names for compatibility
            const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
            const user = localStorage.getItem('user_data') || localStorage.getItem('user');
            
            if (!token) {
                console.log('No authentication token found, redirecting to login');
                window.location.href = '/app.html';
                return;
            }
            
            console.log('Authentication token found, loading account info');
            // Load comprehensive account information
            loadAccountInfo();
        }
        
        // Load comprehensive account information
        async function loadAccountInfo() {
            try {
                const accountData = await makeRequest('/api/v1/account/summary');
                if (accountData) {
                    updateAccountDisplay(accountData);
                } else {
                    // Fallback to basic user info from localStorage
                    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
                    document.getElementById('username-display').textContent = userData.username || 'User';
                    document.getElementById('display-name').textContent = userData.username || 'User';
                    document.getElementById('account-number').textContent = 'Loading...';
                }
            } catch (error) {
                console.error('Failed to load account info:', error);
                showAlert('Failed to load account information', 'info');
            }
        }
        
        // Update account display with comprehensive information
        function updateAccountDisplay(accountData) {
            // Account header
            document.getElementById('account-number').textContent = accountData.account_number;
            document.getElementById('display-name').textContent = accountData.display_name;
            document.getElementById('username-display').textContent = accountData.username;
            document.getElementById('email-display').textContent = accountData.email;
            
            // Account status
            const accountStatusIndicator = document.getElementById('account-status-indicator');
            const accountStatusText = document.getElementById('account-status-text');
            accountStatusIndicator.className = `status-indicator status-${accountData.account_status_color}`;
            accountStatusText.textContent = accountData.account_status.charAt(0).toUpperCase() + accountData.account_status.slice(1);
            
            // Verification status
            const verificationStatusIndicator = document.getElementById('verification-status-indicator');
            const verificationStatusText = document.getElementById('verification-status-text');
            if (accountData.is_verified) {
                verificationStatusIndicator.className = 'status-indicator status-green';
                verificationStatusText.textContent = 'Verified';
            } else if (accountData.email_verified) {
                verificationStatusIndicator.className = 'status-indicator status-yellow';
                verificationStatusText.textContent = 'Partial';
            } else {
                verificationStatusIndicator.className = 'status-indicator status-red';
                verificationStatusText.textContent = 'Unverified';
            }
            
            // API connections
            updateApiConnectionsList(accountData.api_connections);
            
            // Account metrics
            document.getElementById('account-age').textContent = accountData.account_age_days.toString();
            document.getElementById('login-count').textContent = accountData.login_count.toString();
        }
        
        // Update API connections list
        function updateApiConnectionsList(apiConnections) {
            const apiList = document.getElementById('api-connections-list');
            
            if (!apiConnections || apiConnections.length === 0) {
                apiList.innerHTML = `
                    <div class="api-item">
                        <div class="api-info">
                            <div class="api-name">No API connections</div>
                            <div class="api-platform">Add connections in Settings</div>
                        </div>
                        <span class="status-indicator status-gray"></span>
                    </div>
                `;
                return;
            }
            
            apiList.innerHTML = '';
            
            apiConnections.forEach(api => {
                const apiItem = document.createElement('div');
                apiItem.className = 'api-item';
                
                const statusText = api.status.charAt(0).toUpperCase() + api.status.slice(1);
                const activeText = api.is_active ? '' : ' (Inactive)';
                
                apiItem.innerHTML = `
                    <div class="api-info">
                        <div class="api-name">${api.name}${activeText}</div>
                        <div class="api-platform">${api.platform} ‚Ä¢ ${statusText}</div>
                    </div>
                    <span class="status-indicator status-${api.status_color}" 
                          title="${api.error_message || api.status}"></span>
                `;
                
                apiList.appendChild(apiItem);
            });
        }
        
        // Refresh API connection status
        async function refreshApiStatus() {
            const refreshBtn = document.getElementById('refresh-api-btn');
            const refreshText = document.getElementById('refresh-text');
            
            // Show loading state
            refreshText.innerHTML = '<span class="loading-spinner"></span>';
            refreshBtn.disabled = true;
            
            try {
                const result = await makeRequest('/api/v1/account/refresh-api-status', { method: 'POST' });
                if (result) {
                    showAlert(`API connections refreshed: ${result.updated_count} tested`, 'info');
                    
                    // Reload account info to get updated statuses
                    setTimeout(loadAccountInfo, 1000);
                } else {
                    showAlert('Failed to refresh API connections', 'info');
                }
            } catch (error) {
                console.error('Failed to refresh API status:', error);
                showAlert('Failed to refresh API connections', 'info');
            } finally {
                // Reset button state
                refreshText.textContent = 'Refresh';
                refreshBtn.disabled = false;
            }
        }
        
        // Show alert
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.page-section');
            sections.forEach(section => section.style.display = 'none');
            
            // Remove active class from nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            // Show selected section
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Add active class to clicked nav item
            event.currentTarget.classList.add('active');
            
            // Show info about section selection
            if (sectionName !== 'dashboard') {
                showAlert(`${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} section selected. Enhanced features available in full React application.`);
            }
        }
        
        // Logout
        async function logout() {
            try {
                // Call backend logout endpoint to log the event
                const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
                if (token) {
                    await fetch(`${API_BASE}/api/v1/auth/logout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }
            } catch (error) {
                console.log('Backend logout call failed:', error);
                // Continue with logout even if backend call fails
            }
            
            // Clear all possible token storage locations
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('demo_mode');
            
            showAlert('Logged out successfully. Redirecting...', 'info');
            setTimeout(() => {
                window.location.href = '/app.html';
            }, 1500);
        }
        
        // Check React app status
        async function checkReactStatus() {
            try {
                const response = await fetch('/');
                const text = await response.text();
                
                if (text.includes('webpack compiled with 1 error')) {
                    showAlert('React application is compiling... Using fallback interface.', 'info');
                } else if (text.includes('Compiled successfully')) {
                    showAlert('React application compiled successfully! Refresh to use the enhanced interface.', 'info');
                }
            } catch (error) {
                console.log('Could not check React status:', error);
            }
        }
        
        // API Helper functions
        async function makeRequest(endpoint, options = {}) {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                },
                ...options
            };
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, defaultOptions);
                
                if (response.status === 401) {
                    // Token expired, redirect to login
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_data');
                    localStorage.removeItem('demo_mode');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/app.html';
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API request failed for ${endpoint}:`, error);
                return null;
            }
        }
        
        // Load real-time portfolio data
        async function loadPortfolioData() {
            const data = await makeRequest('/api/v1/portfolio/summary');
            if (!data) return;
            
            // Update portfolio value
            const portfolioValue = document.getElementById('portfolio-value');
            if (portfolioValue && data.total_value) {
                portfolioValue.textContent = `$${parseFloat(data.total_value).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                
                // Update change indicator
                const pnlPercent = data.total_pnl_percent || 0;
                const changeElement = portfolioValue.nextElementSibling;
                if (changeElement) {
                    const isPositive = pnlPercent >= 0;
                    changeElement.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
                    changeElement.innerHTML = `
                        <span>${isPositive ? 'üìà' : 'üìâ'} ${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%</span>
                        <span style="margin-left: 0.5rem;">${isPositive ? '+' : ''}$${parseFloat(data.total_pnl || 0).toFixed(2)} total</span>
                    `;
                }
            }
            
            // Update available cash
            const availableCash = document.querySelector('.stat-card:nth-child(2) .stat-value');
            if (availableCash && data.available_cash) {
                availableCash.textContent = `$${parseFloat(data.available_cash).toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
            }
            
            // Update active bots count
            const activeBots = document.querySelector('.stat-card:nth-child(3) .stat-value');
            if (activeBots && typeof data.active_bots !== 'undefined') {
                activeBots.textContent = `${data.active_bots} / ${data.number_of_bots}`;
                const botStatus = activeBots.nextElementSibling;
                if (botStatus) {
                    botStatus.innerHTML = `<span>${data.active_bots} running, ${data.number_of_bots - data.active_bots} stopped</span>`;
                }
            }
        }
        
        // Load trading bots data
        async function loadBotsData() {
            const botsData = await makeRequest('/api/v1/bots/');
            const performanceData = await makeRequest('/api/v1/portfolio/bot-performance');
            
            if (!botsData && !performanceData) return;
            
            const botList = document.getElementById('bot-list');
            if (!botList) return;
            
            // Combine bots data with performance data
            const bots = botsData || [];
            const performance = performanceData || [];
            
            const performanceMap = {};
            performance.forEach(perf => {
                performanceMap[perf.bot_id] = perf;
            });
            
            botList.innerHTML = '';
            
            bots.forEach(bot => {
                const perf = performanceMap[bot.id] || {};
                const isRunning = bot.status === 'running';
                
                const botItem = document.createElement('li');
                botItem.className = 'bot-item';
                botItem.innerHTML = `
                    <div class="bot-info">
                        <h4>${bot.name}</h4>
                        <p>${bot.description || 'Trading bot'} ‚Ä¢ ${parseFloat(bot.allocated_percentage || 0).toFixed(1)}% allocation ‚Ä¢ $${parseFloat(perf.current_value || bot.allocated_amount || 0).toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        })} value</p>
                    </div>
                    <div class="bot-status">
                        <span class="status-indicator ${isRunning ? 'status-running' : 'status-stopped'}"></span>
                        <span>${isRunning ? 'Running' : 'Stopped'}</span>
                        <button class="btn btn-secondary" onclick="configureBot(${bot.id})">Configure</button>
                        <button class="btn ${isRunning ? 'btn-secondary' : 'btn-primary'}" onclick="${isRunning ? 'stopBot' : 'startBot'}(${bot.id})">
                            ${isRunning ? 'Stop Bot' : 'Start Bot'}
                        </button>
                    </div>
                `;
                botList.appendChild(botItem);
            });
            
            // Update holdings count from bots data
            const holdingsCount = document.querySelector('.stat-card:nth-child(4) .stat-value');
            if (holdingsCount) {
                const totalPositions = performance.reduce((sum, perf) => sum + (perf.active_positions || 0), 0);
                holdingsCount.textContent = totalPositions.toString();
                const holdingsStatus = holdingsCount.nextElementSibling;
                if (holdingsStatus) {
                    holdingsStatus.innerHTML = `<span>Positions active</span>`;
                }
            }
        }
        
        // Load market data for dashboard
        async function loadMarketData() {
            // This could load trending stocks, market alerts, etc.
            try {
                const alerts = await makeRequest('/api/v1/market-data/alerts?limit=3');
                if (alerts && alerts.length > 0) {
                    // Show recent market alerts
                    alerts.forEach(alert => {
                        if (alert.severity === 'high' || alert.severity === 'critical') {
                            showAlert(`Market Alert: ${alert.message}`, 'info');
                        }
                    });
                }
            } catch (error) {
                console.log('Could not load market alerts:', error);
            }
        }
        
        // Bot control functions
        async function startBot(botId) {
            showAlert(`Starting bot ${botId}...`, 'info');
            const result = await makeRequest(`/api/v1/bots/${botId}/start`, { method: 'POST' });
            
            if (result) {
                showAlert(result.message || 'Bot started successfully', 'info');
                await loadBotsData(); // Refresh bot list
                await loadPortfolioData(); // Refresh portfolio stats
            } else {
                showAlert('Failed to start bot', 'info');
            }
        }
        
        async function stopBot(botId) {
            showAlert(`Stopping bot ${botId}...`, 'info');
            const result = await makeRequest(`/api/v1/bots/${botId}/stop`, { method: 'POST' });
            
            if (result) {
                showAlert(result.message || 'Bot stopped successfully', 'info');
                await loadBotsData(); // Refresh bot list
                await loadPortfolioData(); // Refresh portfolio stats
            } else {
                showAlert('Failed to stop bot', 'info');
            }
        }
        
        function configureBot(botId) {
            showAlert(`Bot configuration for bot ${botId} - Full interface available in React app`, 'info');
        }
        
        // Enhanced section display with data loading
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.page-section');
            sections.forEach(section => section.style.display = 'none');
            
            // Remove active class from nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            // Show selected section
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Add active class to clicked nav item
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // Load section-specific data
            if (sectionName === 'dashboard') {
                loadDashboardData();
            } else if (sectionName === 'portfolio') {
                loadPortfolioSection();
            } else if (sectionName === 'market') {
                loadMarketSection();
            } else if (sectionName === 'bots') {
                loadBotsSection();
            } else if (sectionName === 'settings') {
                loadSettingsSection();
            } else {
                // Show info about React app status
                showAlert(`${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} section selected. Full React application features will be available once compilation completes.`);
            }
        }
        
        // Load data for each section
        async function loadDashboardData() {
            await Promise.all([
                loadPortfolioData(),
                loadBotsData(),
                loadMarketData()
            ]);
        }
        
        // API Connection Management Functions
        
        // Show add connection modal
        function showAddConnectionModal() {
            document.getElementById('add-connection-modal').style.display = 'block';
            resetConnectionForm();
        }
        
        // Close add connection modal
        function closeAddConnectionModal() {
            document.getElementById('add-connection-modal').style.display = 'none';
            resetConnectionForm();
        }
        
        // Reset connection form
        function resetConnectionForm() {
            document.getElementById('add-connection-form').reset();
            document.getElementById('robinhood-fields').style.display = 'none';
            document.getElementById('alpha-vantage-fields').style.display = 'none';
            document.getElementById('yahoo-finance-fields').style.display = 'none';
            document.getElementById('connection-testing').style.display = 'none';
            
            document.getElementById('test-connection-btn').disabled = true;
            document.getElementById('save-connection-btn').disabled = true;
        }
        
        // Update connection form based on selected platform
        function updateConnectionForm() {
            const platform = document.getElementById('platform').value;
            const connectionName = document.getElementById('connection-name');
            
            // Hide all platform-specific fields
            document.getElementById('robinhood-fields').style.display = 'none';
            document.getElementById('alpha-vantage-fields').style.display = 'none';
            document.getElementById('yahoo-finance-fields').style.display = 'none';
            
            // Show relevant fields and set default name
            if (platform === 'robinhood') {
                document.getElementById('robinhood-fields').style.display = 'block';
                if (!connectionName.value) connectionName.value = 'My Robinhood Account';
            } else if (platform === 'alpha_vantage') {
                document.getElementById('alpha-vantage-fields').style.display = 'block';
                if (!connectionName.value) connectionName.value = 'Alpha Vantage Data';
            } else if (platform === 'yahoo_finance') {
                document.getElementById('yahoo-finance-fields').style.display = 'block';
                if (!connectionName.value) connectionName.value = 'Yahoo Finance Data';
            }
            
            // Enable test button if platform is selected
            document.getElementById('test-connection-btn').disabled = !platform;
        }
        
        // Test API connection
        async function testConnection() {
            const platform = document.getElementById('platform').value;
            const connectionName = document.getElementById('connection-name').value;
            
            if (!platform || !connectionName) {
                showAlert('Please select a platform and enter a connection name', 'info');
                return;
            }
            
            // Show testing UI
            const testingDiv = document.getElementById('connection-testing');
            const testingMessage = document.getElementById('testing-message');
            const testBtn = document.getElementById('test-connection-btn');
            const saveBtn = document.getElementById('save-connection-btn');
            
            testingDiv.style.display = 'block';
            testingMessage.textContent = 'Testing connection...';
            testBtn.disabled = true;
            saveBtn.disabled = true;
            
            try {
                // Gather credentials based on platform
                const credentials = gatherCredentials(platform);
                
                const response = await makeRequest('/api/v1/settings/credentials', {
                    method: 'POST',
                    body: JSON.stringify({
                        platform: platform,
                        name: connectionName,
                        ...credentials
                    })
                });
                
                if (response) {
                    testingMessage.textContent = 'Connection test successful!';
                    testingDiv.style.backgroundColor = 'rgba(0, 255, 136, 0.1)';
                    testingDiv.style.borderColor = 'rgba(0, 255, 136, 0.3)';
                    testingMessage.style.color = '#00ff88';
                    
                    saveBtn.disabled = false;
                    showAlert('Connection test successful! You can now save this connection.', 'info');
                    
                    // Auto-save for Yahoo Finance since it doesn't require auth
                    if (platform === 'yahoo_finance') {
                        setTimeout(saveConnection, 1000);
                    }
                } else {
                    throw new Error('Connection test failed');
                }
            } catch (error) {
                testingMessage.textContent = `Connection failed: ${error.message || 'Unknown error'}`;
                testingDiv.style.backgroundColor = 'rgba(255, 107, 107, 0.1)';
                testingDiv.style.borderColor = 'rgba(255, 107, 107, 0.3)';
                testingMessage.style.color = '#ff6b6b';
                
                showAlert(`Connection test failed: ${error.message || 'Unknown error'}`, 'info');
            }
            
            testBtn.disabled = false;
        }
        
        // Gather credentials from form
        function gatherCredentials(platform) {
            const credentials = {};
            
            if (platform === 'robinhood') {
                credentials.username = document.getElementById('rh-username').value;
                credentials.password = document.getElementById('rh-password').value;
                const mfaCode = document.getElementById('rh-mfa').value;
                if (mfaCode) credentials.mfa_code = mfaCode;
            } else if (platform === 'alpha_vantage') {
                credentials.api_key = document.getElementById('av-api-key').value;
            }
            // Yahoo Finance doesn't need credentials
            
            return credentials;
        }
        
        // Save connection after successful test
        async function saveConnection() {
            try {
                const saveBtn = document.getElementById('save-connection-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                // Connection already saved during test, just close modal
                closeAddConnectionModal();
                showAlert('API connection saved successfully!', 'info');
                
                // Refresh connections display
                await loadApiConnections();
                await loadAccountInfo(); // Refresh sidebar
                
            } catch (error) {
                showAlert(`Failed to save connection: ${error.message}`, 'info');
                document.getElementById('save-connection-btn').disabled = false;
                document.getElementById('save-connection-btn').textContent = 'Save Connection';
            }
        }
        
        // Load and display API connections
        async function loadApiConnections() {
            try {
                const connections = await makeRequest('/api/v1/settings/credentials');
                const grid = document.getElementById('api-connections-grid');
                
                if (!connections || connections.length === 0) {
                    grid.innerHTML = `
                        <div class="connection-card placeholder">
                            <div class="connection-header">
                                <span>No API connections configured</span>
                            </div>
                            <p style="color: #aaa; font-size: 0.9rem;">Add your first connection to start trading</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = '';
                
                connections.forEach(conn => {
                    const statusColor = getApiStatusColor(conn.status);
                    const platformName = getPlatformDisplayName(conn.platform);
                    
                    const card = document.createElement('div');
                    card.className = 'connection-card';
                    card.innerHTML = `
                        <div class="connection-header">
                            <div>
                                <div class="connection-title">${conn.name}</div>
                                <div class="connection-platform">${platformName}</div>
                            </div>
                            <span class="status-indicator status-${statusColor}" 
                                  title="${conn.status}"></span>
                        </div>
                        
                        <div class="connection-status">
                            <span class="status-indicator status-${statusColor}"></span>
                            <span>${conn.status.charAt(0).toUpperCase() + conn.status.slice(1)}</span>
                        </div>
                        
                        <div class="connection-details">
                            API Key: ${conn.api_key}<br>
                            Last used: ${conn.last_used ? new Date(conn.last_used).toLocaleDateString() : 'Never'}<br>
                            Status: ${conn.is_active ? 'Active' : 'Inactive'}
                        </div>
                        
                        <div class="connection-actions">
                            <button class="btn btn-test btn-small" 
                                    onclick="testExistingConnection(${conn.id})">Test</button>
                            <button class="btn btn-edit btn-small" 
                                    onclick="editConnection(${conn.id})">Edit</button>
                            <button class="btn btn-delete btn-small" 
                                    onclick="deleteConnection(${conn.id})">Delete</button>
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
                
            } catch (error) {
                console.error('Failed to load API connections:', error);
                showAlert('Failed to load API connections', 'info');
            }
        }
        
        // Get display name for platform
        function getPlatformDisplayName(platform) {
            const names = {
                'robinhood': 'Robinhood',
                'yahoo_finance': 'Yahoo Finance',
                'alpha_vantage': 'Alpha Vantage'
            };
            return names[platform] || platform;
        }
        
        // Get color for API status
        function getApiStatusColor(status) {
            const colors = {
                'connected': 'green',
                'error': 'red',
                'untested': 'yellow',
                'testing': 'blue'
            };
            return colors[status] || 'gray';
        }
        
        // Test existing connection
        async function testExistingConnection(connectionId) {
            try {
                showAlert('Testing connection...', 'info');
                const result = await makeRequest(`/api/v1/settings/credentials/${connectionId}/test`, {
                    method: 'POST'
                });
                
                if (result) {
                    showAlert('Connection test successful!', 'info');
                    await loadApiConnections(); // Refresh display
                    await loadAccountInfo(); // Refresh sidebar
                } else {
                    throw new Error('Connection test failed');
                }
            } catch (error) {
                showAlert(`Connection test failed: ${error.message}`, 'info');
            }
        }
        
        // Edit connection (placeholder)
        function editConnection(connectionId) {
            showAlert('Edit connection feature will be available in the full React app', 'info');
        }
        
        // Delete connection
        async function deleteConnection(connectionId) {
            if (!confirm('Are you sure you want to delete this API connection?')) {
                return;
            }
            
            try {
                const result = await makeRequest(`/api/v1/settings/credentials/${connectionId}`, {
                    method: 'DELETE'
                });
                
                if (result) {
                    showAlert('Connection deleted successfully', 'info');
                    await loadApiConnections(); // Refresh display
                    await loadAccountInfo(); // Refresh sidebar
                } else {
                    throw new Error('Delete failed');
                }
            } catch (error) {
                showAlert(`Failed to delete connection: ${error.message}`, 'info');
            }
        }
        
        // Save user settings
        async function saveUserSettings() {
            try {
                const settings = {
                    risk_tolerance: document.getElementById('risk-tolerance').value,
                    max_position_size: parseFloat(document.getElementById('max-position-size').value),
                    auto_rebalance: document.getElementById('auto-rebalance').checked,
                    enable_notifications: document.getElementById('notifications').checked
                };
                
                const result = await makeRequest('/api/v1/settings/user', {
                    method: 'POST',
                    body: JSON.stringify(settings)
                });
                
                if (result) {
                    showAlert('Settings saved successfully', 'info');
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                showAlert(`Failed to save settings: ${error.message}`, 'info');
            }
        }
        
        async function loadPortfolioSection() {
            showAlert('Loading portfolio data...', 'info');
            const positions = await makeRequest('/api/v1/portfolio/positions');
            const riskMetrics = await makeRequest('/api/v1/portfolio/risk-metrics');
            
            if (positions || riskMetrics) {
                showAlert('Portfolio data loaded. Full portfolio analytics available in React app.', 'info');
            }
        }
        
        async function loadMarketSection() {
            showAlert('Loading market data...', 'info');
            // Could load watchlist, trending stocks, etc.
            showAlert('Market data section - Real-time data and charts available in React app.', 'info');
        }
        
        async function loadBotsSection() {
            showAlert('Loading bot management interface...', 'info');
            await loadBotsData();
            showAlert('Bot data loaded. Full bot configuration available in React app.', 'info');
        }
        
        async function loadSettingsSection() {
            showAlert('Loading API connections and settings...', 'info');
            await loadApiConnections();
            showAlert('Settings loaded. You can now manage your API connections.', 'info');
        }
        
        // Security section functions
        async function updatePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('Please fill in all password fields', 'info');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match', 'info');
                return;
            }
            
            if (newPassword.length < 8) {
                showAlert('New password must be at least 8 characters long', 'info');
                return;
            }
            
            showAlert('Password update functionality will be available in the full React app', 'info');
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('add-connection-modal');
            if (event.target === modal) {
                closeAddConnectionModal();
            }
        }
        
        // Auto-refresh data every 30 seconds when on dashboard
        let refreshInterval;
        let accountRefreshInterval;
        
        function startAutoRefresh() {
            // Clear existing intervals
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (accountRefreshInterval) {
                clearInterval(accountRefreshInterval);
            }
            
            // Set up dashboard data auto-refresh (30 seconds)
            refreshInterval = setInterval(async () => {
                const dashboardSection = document.getElementById('dashboard-section');
                if (dashboardSection && dashboardSection.style.display !== 'none') {
                    await loadDashboardData();
                }
            }, 30000);
            
            // Set up account info auto-refresh (60 seconds)
            accountRefreshInterval = setInterval(async () => {
                await loadAccountInfo();
            }, 60000);
        }
        
        // Stop auto-refresh when page becomes hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                if (accountRefreshInterval) {
                    clearInterval(accountRefreshInterval);
                    accountRefreshInterval = null;
                }
            } else {
                // Resume auto-refresh when page becomes visible
                startAutoRefresh();
            }
        });
        
        // Initialize
        checkAuth();
        checkReactStatus();
        loadDashboardData();
        startAutoRefresh();
        
        // Show welcome message
        setTimeout(() => {
            showAlert('Welcome to SirHiss Trading Platform! Real-time data is now loading from the backend.');
        }, 1000);
    </script>
</body>
</html>